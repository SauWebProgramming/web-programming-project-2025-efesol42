@using BendenSana.Models
@model Product

@{
    ViewData["Title"] = Model.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";

    var firstImage = Model.Images?.FirstOrDefault()?.ImageUrl ?? "https://placehold.co/600x600?text=No+Image";

    // Yorum Hesaplamaları
    var ratedReviews = Model.Reviews.Where(r => r.Rating.HasValue).ToList();
    double avgRating = ratedReviews.Any() ? ratedReviews.Average(r => r.Rating.Value) : 0;
    int reviewCount = Model.Reviews.Count;
}

<style>
    /* GENEL STİLLER */
    .product-title {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        font-size: 24px;
        color: #000;
    }

    .product-price {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 24px;
        color: #000;
        margin-top: 10px;
    }

    .product-desc {
        font-family: 'Poppins', sans-serif;
        font-weight: 400;
        font-size: 14px;
        color: #000;
        line-height: 24px;
        margin-top: 24px;
    }

    /* GÖRSEL ALANI */
    .thumbnail-container {
        background: #F5F5F5;
        border-radius: 4px;
        width: 100%;
        height: 138px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-bottom: 16px;
        transition: all 0.2s;
    }

        .thumbnail-container:hover {
            border: 1px solid #DB4444;
        }

    .thumbnail-img {
        max-width: 80%;
        max-height: 80%;
        object-fit: contain;
    }

    .main-image-container {
        background: #F5F5F5;
        border-radius: 4px;
        height: 600px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* TESLİMAT KUTUSU */
    .delivery-box {
        border: 1px solid rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        overflow: hidden;
    }

    .delivery-item {
        padding: 24px 16px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

        .delivery-item:first-child {
            border-bottom: 1px solid rgba(0, 0, 0, 0.5);
        }

    .delivery-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        font-size: 16px;
        color: #000;
    }

    .delivery-text {
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        font-size: 12px;
        color: #000;
    }

    .delivery-link {
        text-decoration: underline;
        cursor: pointer;
    }

    /* NİTELİK SATIRLARI */
    .attribute-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        font-family: 'Inter', sans-serif;
        font-size: 16px;
    }

    .attribute-value {
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
        border: 1px solid rgba(0,0,0,0.5);
        border-radius: 4px;
        padding: 6px 12px;
        min-width: 80px;
        text-align: center;
    }

    /* BENZER ÜRÜNLER KARTI */
    .group-hover-effect:hover img {
        transform: scale(1.05);
    }

    .group-hover-effect:hover .add-to-cart-overlay {
        opacity: 1 !important;
    }
</style>

<div class="container py-5">

    <div class="d-flex align-items-center gap-2 mb-5 text-muted small">
        <a asp-controller="Home" asp-action="Index" class="text-decoration-none text-muted">Ana Sayfa</a> /
        <a href="#" class="text-decoration-none text-muted">@Model.Category?.Name</a> /
        <span class="text-dark fw-bold">@Model.Title</span>
    </div>

    <div class="row">
        <div class="col-lg-2 col-md-3 order-2 order-md-1">
            <div class="d-flex flex-column">
                @if (Model.Images != null && Model.Images.Any())
                {
                    foreach (var img in Model.Images)
                    {
                        <div class="thumbnail-container" onclick="changeMainImage('@img.ImageUrl')">
                            <img src="@img.ImageUrl" class="thumbnail-img">
                        </div>
                    }
                }
                else
                {
                    <div class="thumbnail-container">
                        <img src="https://placehold.co/100x100?text=No+Img" class="thumbnail-img">
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-5 col-md-9 order-1 order-md-2 mb-4 mb-md-0">
            <div class="main-image-container">
                <img id="mainImage" src="@firstImage" class="img-fluid" style="max-height: 90%; max-width: 90%; object-fit: contain;">
            </div>
        </div>

        <div class="col-lg-5 order-3 ps-lg-5">
            <h1 class="product-title">@Model.Title</h1>

            <div class="d-flex align-items-center gap-2 mt-2">
                <div class="text-warning small">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= Math.Round(avgRating))
                        {
                            <i class="bi bi-star-fill"></i>
                        }
                        else
                        {
                            <i class="bi bi-star"></i>
                        }
                    }
                </div>
                <span class="text-muted small">(@reviewCount İnceleme)</span>
                <span class="text-muted small">|</span>
                <span class="text-success small fw-bold">Stokta Var</span>
            </div>

            <div class="product-price">@Model.Price.ToString("C2")</div>

            <p class="product-desc">@Model.Description</p>

            <hr class="my-4" style="opacity: 0.2;">

            <div class="mb-4">
                <div class="attribute-row">
                    <span>Satıcı:</span>
                    <div class="attribute-value">@(Model.Seller?.UserName ?? "Bilinmiyor")</div>
                </div>
                <div class="attribute-row">
                    <span>Kategori:</span>
                    <div class="attribute-value">@(Model.Category?.Name ?? "Genel")</div>
                </div>
                <div class="attribute-row">
                    <span>Durum:</span>
                    <div class="attribute-value">@Model.Status</div>
                </div>
            </div>

            <div class="d-flex flex-column gap-3 mb-4">
                <form asp-controller="Cart" asp-action="AddToCart" method="post" class="d-flex gap-3">
                    <input type="hidden" name="productId" value="@Model.Id" />

                    <div class="d-flex align-items-center border rounded" style="width: 140px; height: 44px;">
                        <button type="button" class="btn btn-link text-dark text-decoration-none px-3" onclick="decrementValue()">-</button>
                        <input type="number" id="quantity" name="quantity" value="1" min="1" max="10" class="form-control border-0 text-center p-0" style="font-weight: 500;">
                        <button type="button" class="btn btn-link text-danger text-decoration-none px-3" onclick="incrementValue()">+</button>
                    </div>

                    <button type="submit" class="btn btn-danger flex-grow-1 text-white fw-medium" style="height: 44px; border-radius: 4px;">
                        Hemen Satın Al
                    </button>

                    <button type="submit" formaction="@Url.Action("Toggle", "Favorite")" class="btn border rounded d-flex align-items-center justify-content-center" style="width: 44px; height: 44px;">
                        <i class="bi @(ViewBag.IsFavorite == true ? "bi-heart-fill text-danger" : "bi-heart")"></i>
                    </button>
                </form>

                <div class="d-flex gap-2">
                    <a asp-controller="Trade" asp-action="Create" asp-route-targetProductId="@Model.Id" class="btn btn-outline-dark flex-grow-1">
                        <i class="bi bi-arrow-left-right me-2"></i>Takas İste
                    </a>
                    <a asp-controller="Product" asp-action="Report" asp-route-id="@Model.Id" class="btn btn-outline-secondary" title="Şikayet Et">
                        <i class="bi bi-flag"></i>
                    </a>
                </div>
            </div>

            <div class="delivery-box mt-4">
                <div class="delivery-item">
                    <i class="bi bi-truck fs-3"></i>
                    <div>
                        <div class="delivery-title">Ücretsiz Teslimat</div>
                        <div class="delivery-text">
                            <span class="delivery-link">Teslimat durumunu kontrol etmek için posta kodunuzu girin</span>
                        </div>
                    </div>
                </div>
                <div class="delivery-item">
                    <i class="bi bi-arrow-repeat fs-3"></i>
                    <div>
                        <div class="delivery-title">İade Garantisi</div>
                        <div class="delivery-text">
                            30 Gün İçinde Ücretsiz İade. <span class="delivery-link">Detaylar</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-5 pt-5">
        <div class="d-flex align-items-center gap-3 mb-4">
            <div style="width: 20px; height: 40px; background: #DB4444; border-radius: 4px;"></div>
            <h4 class="text-danger fw-bold m-0" style="font-family: 'Poppins', sans-serif;">Benzer Ürünler</h4>
        </div>

        <div class="row">
            @if (ViewBag.RelatedProducts != null && ((List<Product>)ViewBag.RelatedProducts).Any())
            {
                foreach (var item in (List<Product>)ViewBag.RelatedProducts)
                {
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                        <div class="card border-0 h-100 position-relative group-hover-effect shadow-sm">
                            <div class="bg-light rounded p-3 d-flex align-items-center justify-content-center position-relative" style="height: 250px; overflow: hidden;">
                                <img src="@(item.Images?.FirstOrDefault()?.ImageUrl ?? "https://placehold.co/400x300")"
                                     class="img-fluid"
                                     style="max-height: 100%; object-fit: contain; transition: transform 0.3s;">

                                <div class="position-absolute w-100 text-center add-to-cart-overlay" style="bottom: 0; background: black; color: white; padding: 8px; opacity: 0; transition: opacity 0.3s;">
                                    <a asp-action="Details" asp-route-id="@item.Id" class="text-white text-decoration-none small stretched-link">Göz At</a>
                                </div>
                            </div>

                            <div class="card-body px-0">
                                <h6 class="fw-bold mb-1 text-truncate">@item.Title</h6>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-danger fw-bold">@item.Price.ToString("C2")</span>
                                </div>
                                <div class="d-flex align-items-center gap-1 mt-1 text-warning small">
                                    <i class="bi bi-star-fill"></i>
                                    <i class="bi bi-star-fill"></i>
                                    <i class="bi bi-star-fill"></i>
                                    <i class="bi bi-star-fill"></i>
                                    <i class="bi bi-star-half"></i>
                                    <span class="text-muted ms-1">(88)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="alert alert-light border text-center">Bu kategoride başka benzer ürün bulunamadı.</div>
                </div>
            }
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mb-4">
                <div style="width: 20px; height: 40px; background: #DB4444; border-radius: 4px;"></div>
                <h3 class="fw-bold m-0" style="font-family: 'Inter', sans-serif;">Değerlendirmeler (@reviewCount)</h3>
            </div>

            <div class="row">
                <div class="col-lg-7">
                    @if (Model.Reviews != null && Model.Reviews.Any())
                    {
                        @foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
                        {
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="fw-bold">@review.User?.UserName</h6>
                                        <small class="text-muted">@review.CreatedAt.ToString("dd MMM yyyy")</small>
                                    </div>
                                    <div class="text-warning small mb-2">
                                        @for (int i = 0; i < (review.Rating ?? 0); i++)
                                        {
                                            <i class="bi bi-star-fill"></i>
                                        }
                                    </div>
                                    <p class="text-muted mb-0">@review.Comment</p>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-light border">Bu ürün için henüz yorum yapılmamış.</div>
                    }
                </div>

                <div class="col-lg-5">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="card border-0 bg-light p-4">
                            <h5 class="fw-bold mb-3">Yorum Ekle</h5>
                            <form asp-action="AddReview" method="post">
                                <input type="hidden" name="productId" value="@Model.Id" />
                                <div class="mb-3">
                                    <label class="form-label">Puanınız</label>
                                    <select name="rating" class="form-select">
                                        <option value="5">⭐⭐⭐⭐⭐ - Çok İyi</option>
                                        <option value="4">⭐⭐⭐⭐ - İyi</option>
                                        <option value="3">⭐⭐⭐ - Orta</option>
                                        <option value="2">⭐⭐ - Kötü</option>
                                        <option value="1">⭐ - Çok Kötü</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Yorumunuz</label>
                                    <textarea name="comment" class="form-control" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-dark w-100">Gönder</button>
                            </form>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function changeMainImage(src) {
        document.getElementById('mainImage').src = src;
    }

    function incrementValue() {
        var el = document.getElementById('quantity');
        var val = parseInt(el.value) || 0;
        if (val < 10) el.value = val + 1;
    }

    function decrementValue() {
        var el = document.getElementById('quantity');
        var val = parseInt(el.value) || 0;
        if (val > 1) el.value = val - 1;
    }
</script>