@using BendenSana.ViewModels
@using BendenSana.Models
@model SearchViewModel

@{
    ViewData["Title"] = "Arama Sonuçları";
}


<style>
    /* Kaydırma çubuğunu (Scrollbar) özelleştirme */
    .category-scroll-container::-webkit-scrollbar {
        width: 6px;
    }

    .category-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .category-scroll-container::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 10px;
    }

        .category-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #db4444; /* Sitenin ana rengi ile uyumlu olsun */
        }

    @@media (min-width: 992px) { /* Sadece geniş ekranlarda (laptop/masaüstü) sticky olsun */
        .sticky-filter

    {
        position: -webkit-sticky; /* Safari desteği */
        position: sticky;
        top: 120px; /* Üstten bırakılacak boşluk */
        align-self: flex-start; /* Bootstrap row içindeki boyunu içeriğe göre ayarlar */
        /* Opsiyonel: Eğer filtreler çok uzunsa panelin kendi içinde scroll olmasını sağlar */
        max-height: 80vh;
        overflow-y: auto;
    }

    /* Sticky panel içindeki scrollbar'ı daha şık yapalım */
    .sticky-filter::-webkit-scrollbar {
        width: 4px;
    }

    .sticky-filter::-webkit-scrollbar-thumb {
        background: #eee;
        border-radius: 10px;
    }

    }
</style>


<div class="container mt-1 mb-1">
    <div class="text-center">
        <h2 class="fw-bold text-dark">Arama Sonuçları</h2>
        <p class="text-muted">
            "@(Model.SearchQuery ?? "Tüm Ürünler")" için sonuçlar:
        </p>
    </div>
</div>

<div class="container mb-5">
    <form asp-controller="Product" asp-action="Search" method="get" id="filterForm">

        <input type="hidden" asp-for="SearchQuery" />

        <div class="row" >
            <div class="col-lg-3 mb-4" >
                <div class="pe-lg-3 sticky-filter" style="top: 120px;">

                    <div class="mb-4 border-bottom pb-4">
                        <h6 class="fw-bold mb-3">Kategoriler</h6>
                        <div class="category-scroll-container" style="max-height: 150px; overflow-y: auto; padding-right: 10px;">
                            <div class="d-flex flex-column gap-2">
                                @foreach (var cat in Model.AllCategories)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="SelectedCategoryIds"
                                               value="@cat.Id" id="cat_@cat.Id"
                                        @(Model.SelectedCategoryIds.Contains(cat.Id) ? "checked" : "")>
                                        <label class="form-check-label fw-semibold" for="cat_@cat.Id">
                                            @cat.Name
                                        </label>
                                    </div>
                                    @if (cat.Children != null && cat.Children.Any())
                                    {
                                        <div class="ms-4 d-flex flex-column gap-1">
                                            @foreach (var child in cat.Children)
                                            {
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="SelectedCategoryIds"
                                                           value="@child.Id" id="cat_@child.Id"
                                                    @(Model.SelectedCategoryIds.Contains(child.Id) ? "checked" : "")>
                                                    <label class="form-check-label text-muted small" for="cat_@child.Id">
                                                        @child.Name
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 border-bottom pb-4">
                        <h6 class="fw-bold mb-3">Cinsiyet</h6>
                        <div class="category-scroll-container" style="max-height: 50px; overflow-y: auto; padding-right: 10px;">
                            <div class="d-flex flex-column gap-2">
                                @foreach (var gender in Enum.GetValues(typeof(ProductGender)).Cast<ProductGender>())
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="SelectedGenders"
                                               value="@gender" id="g_@gender"
                                               @(Model.SelectedGenders.Contains(gender) ? "checked" : "")>
                                        <label class="form-check-label" for="g_@gender">@gender</label>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 border-bottom pb-4">
                        <h6 class="fw-bold mb-3">Fiyat Aralığı</h6>
                        <div class="d-flex gap-2 align-items-center">
                            <input type="number" asp-for="MinPrice" class="form-control form-control-sm" placeholder="Min">
                            <span>-</span>
                            <input type="number" asp-for="MaxPrice" class="form-control form-control-sm" placeholder="Max">
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Renk</h6>
                        <div class="category-scroll-container" style="max-height: 50px; overflow-y: auto; padding-right: 10px;">
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var color in Model.AllColors)
                                {
                                    var isChecked = Model.SelectedColorIds.Contains(color.Id);
                                    // Sayfa yüklendiğinde seçili olanların kenarlığı siyah olsun
                                    var initialBorder = isChecked ? "2px solid #000" : "1px solid #ddd";
                                    var hex = !string.IsNullOrEmpty(color.HexCode) ? color.HexCode : "#ccc";

                                    <label style="cursor: pointer;" title="@color.Name" class="position-relative">
                                        <input type="checkbox" name="SelectedColorIds" value="@color.Id"
                                               class="d-none btn-color-select"
                                               @(isChecked ? "checked" : "")>

                                        <div class="rounded-circle color-circle-visual"
                                             style="width: 32px; height: 32px; background-color: @hex; border: @initialBorder; transition: border 0.2s ease;">
                                        </div>

                                        <div class="text-center mt-1" style="font-size: 10px; max-width: 32px; overflow: hidden; white-space: nowrap;">
                                            @color.Name
                                        </div>
                                    </label>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-dark">Filtreleri Uygula</button>
                        <a href="@Url.Action("Search", "Product")" class="btn btn-outline-secondary btn-sm">Temizle</a>
                    </div>

                </div>
            </div>

            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-4" style="position: sticky; top: 110px; background-color:white; z-index:30000; padding:20px">
                    <span class="text-muted">Toplam <strong>@Model.TotalResults</strong> ürün bulundu</span>
                    <div class="d-flex align-items-center gap-2">
                        <label class="small fw-bold text-nowrap">Sırala:</label>
                        <select asp-for="SortBy" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="newest">En Yeniler</option>
                            <option value="price_asc">Fiyat (Artan)</option>
                            <option value="price_desc">Fiyat (Azalan)</option>
                        </select>
                    </div>
                </div>

                <div class="row g-4">
                    @if (Model.Products.Count == 0)
                    {
                        <div class="col-12 text-center py-5">
                            <h4>Ürün bulunamadı.</h4>
                            <p class="text-muted">Filtreleri değiştirerek tekrar deneyebilirsiniz.</p>
                        </div>
                    }

                    @foreach (var item in Model.Products)
                    {
                        var imgUrl = item.Images.FirstOrDefault()?.ImageUrl ?? "https://placehold.co/300x400?text=Resim+Yok";

                        <div class="col-6 col-md-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="position-relative">
                                    <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id">
                                        <img src="@imgUrl" class="card-img-top" style="height: 300px; object-fit: cover;" alt="@item.Title">
                                    </a>

                                    @if (item.OriginalPrice > item.Price)
                                    {
                                        <span class="badge bg-danger position-absolute top-0 start-0 m-2">İNDİRİM</span>
                                    }
                                </div>

                                <div class="card-body">
                                    <h6 class="card-title fw-bold text-truncate">
                                        <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id" class="text-decoration-none text-dark">
                                            @item.Title
                                        </a>
                                    </h6>

                                    <div class="d-flex gap-2 align-items-center">
                                        <span class="fw-bold" style="color: #DB4444;">$@item.Price.ToString("N0")</span>
                                        @if (item.OriginalPrice > item.Price)
                                        {
                                            <span class="text-muted text-decoration-line-through small">$@item.OriginalPrice?.ToString("N0")</span>
                                        }
                                    </div>

                                    @if (item.Color != null)
                                    {
                                        <div class="d-flex align-items-center gap-1 mt-2">
                                            <div class="rounded-circle border" style="width: 10px; height: 10px; background-color: @(item.Color.HexCode ?? "#ccc")"></div>
                                            <small class="text-muted" style="font-size: 11px;">@item.Color.Name</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Renk kutularını bul
            const colorInputs = document.querySelectorAll(".btn-color-select");

            colorInputs.forEach(function (input) {
                // Her birine tıklama (change) olayı ekle
                input.addEventListener("change", function () {
                    // Inputun hemen yanındaki (görsel daire) elementini bul
                    const circleDiv = this.nextElementSibling;

                    if (this.checked) {
                        // Seçildiyse: Siyah kalın çerçeve
                        circleDiv.style.border = "2px solid #000";
                        circleDiv.style.boxShadow = "0 0 4px rgba(0,0,0,0.3)";
                    } else {
                        // Seçim kalktıysa: Gri ince çerçeve
                        circleDiv.style.border = "1px solid #ddd";
                        circleDiv.style.boxShadow = "none";
                    }
                });
            });
        });
    </script>
}